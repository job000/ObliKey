# ObliKey - Modulbasert Features Konfigurasjon

## üìã Oversikt

Dette dokumentet forklarer ObliKeys modulbaserte arkitektur og hvordan funksjoner enkelt kan aktiveres/deaktiveres per kunde/tenant.

## üéØ Roller i Systemet

### Tenant-niv√• (Gym/Bedrift)
| Rolle | Beskrivelse | Tilgang |
|-------|-------------|---------|
| `SUPER_ADMIN` | Full kontroll over tenant | Alt |
| `ADMIN` | Administrator | Brukere, klasser, betalinger, rapporter |
| `TRAINER` | PT/Instrukt√∏r | Opprette klasser/PT-√∏kter, se egne kunder |
| `CUSTOMER` | Vanlig bruker | Booke timer, se treningsprogrammer |

### Platform-niv√• (SaaS)
| Rolle | Beskrivelse | Tilgang |
|-------|-------------|---------|
| `PLATFORM_OWNER` | Plattform-eier | Full kontroll over hele SaaS |
| `PLATFORM_ADMIN` | Platform admin | H√•ndtere tenants, fakturering |
| `PLATFORM_SUPPORT` | Support-team | Kun lesetilgang |

## üß© Modulbasert Arkitektur

### Backend Struktur

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/      # Business logic per modul
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ class.controller.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking.controller.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pt.controller.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.controller.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.controller.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ routes/           # API endpoints per modul
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.routes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ class.routes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking.routes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pt.routes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.routes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.routes.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ middleware/       # Auth, roller, validering
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ roleCheck.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.ts
‚îÇ   ‚îî‚îÄ‚îÄ services/         # Eksterne tjenester
‚îÇ       ‚îú‚îÄ‚îÄ email.ts
‚îÇ       ‚îú‚îÄ‚îÄ stripe.ts
‚îÇ       ‚îî‚îÄ‚îÄ storage.ts
```

### Frontend Struktur

```
frontend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ pages/           # En side per modul
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DashboardPage.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ClassesPage.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BookingsPage.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PTSessionsPage.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TrainingProgramsPage.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProfilePage.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminPage.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ChatPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ components/      # Gjenbrukbare komponenter
‚îÇ   ‚îú‚îÄ‚îÄ contexts/        # State management
‚îÇ   ‚îî‚îÄ‚îÄ services/        # API klient
```

## ‚öôÔ∏è Feature Flags per Tenant

### Database: `tenant_features` tabell

```typescript
model TenantFeatures {
  id                   String  @id @default(uuid())
  tenantId             String  @unique

  // Booking Features
  booking              Boolean @default(true)
  customerPortal       Boolean @default(false)

  // PT Module
  ptModule             Boolean @default(false)
  trainingPrograms     Boolean @default(false)

  // Payments
  payments             Boolean @default(false)

  // Communication
  emailNotifications   Boolean @default(false)
  smsNotifications     Boolean @default(false)
  pushNotifications    Boolean @default(false)

  // Advanced
  analytics            Boolean @default(false)
  apiAccess            Boolean @default(false)
  mobileApp            Boolean @default(false)
  whiteLabel           Boolean @default(false)
  customDomain         Boolean @default(false)
}
```

### Bruk i Kode

**Backend - Middleware:**
```typescript
// middleware/featureCheck.ts
export const requireFeature = (feature: string) => {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    const tenantId = req.tenantId;

    const features = await prisma.tenantFeatures.findUnique({
      where: { tenantId }
    });

    if (!features || !features[feature]) {
      return res.status(403).json({
        error: 'Denne funksjonen er ikke aktivert for din bedrift'
      });
    }

    next();
  };
};

// Bruk:
router.post('/pt/sessions',
  authenticate,
  requireFeature('ptModule'),
  ptController.createSession
);
```

**Frontend - Hook:**
```typescript
// hooks/useFeatures.ts
export function useFeatures() {
  const [features, setFeatures] = useState(null);

  useEffect(() => {
    // Hent features for current tenant
    fetchTenantFeatures().then(setFeatures);
  }, []);

  return {
    hasFeature: (feature: string) => features?.[feature] || false,
    features
  };
}

// Bruk i komponenter:
const { hasFeature } = useFeatures();

{hasFeature('ptModule') && (
  <Link to="/pt-sessions">PT √òkter</Link>
)}
```

## üì¶ Subscription Plans og Features

### Plan Niv√•er

| Plan | Pris/mnd | Features |
|------|----------|----------|
| **STARTER** | 995 NOK | Booking, basis |
| **BASIC** | 1995 NOK | + Kundeportal, e-post |
| **PRO** | 3995 NOK | + PT-modul, betalinger, SMS |
| **ENTERPRISE** | 7995 NOK | + API, white-label, custom domain |

### Plan -> Features Mapping

```typescript
// Fra platformAdmin.controller.ts
private getPlanFeatures(plan: string): any {
  const features = {
    STARTER: {
      booking: true,
      customerPortal: false,
      ptModule: false,
      payments: false,
      emailNotifications: false,
    },
    BASIC: {
      booking: true,
      customerPortal: true,
      ptModule: false,
      payments: false,
      emailNotifications: true,
    },
    PRO: {
      booking: true,
      customerPortal: true,
      ptModule: true,
      payments: true,
      emailNotifications: true,
      smsNotifications: true,
      analytics: true,
    },
    ENTERPRISE: {
      // Alt aktivert
      booking: true,
      customerPortal: true,
      ptModule: true,
      trainingPrograms: true,
      payments: true,
      emailNotifications: true,
      smsNotifications: true,
      pushNotifications: true,
      analytics: true,
      apiAccess: true,
      mobileApp: true,
      whiteLabel: true,
      customDomain: true,
    }
  };

  return features[plan] || features.STARTER;
}
```

## üîß Legge til Ny Feature

### 1. Database Migration

```prisma
// Legg til i TenantFeatures model
model TenantFeatures {
  // ... existing fields
  newFeature Boolean @default(false)
}
```

Kj√∏r migration:
```bash
npx prisma migrate dev --name add_new_feature
```

### 2. Backend Route

```typescript
// routes/newFeature.routes.ts
import { Router } from 'express';
import { NewFeatureController } from '../controllers/newFeature.controller';
import { authenticate } from '../middleware/auth';
import { requireFeature } from '../middleware/featureCheck';

const router = Router();
const controller = new NewFeatureController();

router.use(authenticate);
router.use(requireFeature('newFeature'));

router.get('/', controller.getAll);
router.post('/', controller.create);

export default router;
```

### 3. Frontend Side

```typescript
// pages/NewFeaturePage.tsx
import { useFeatures } from '../hooks/useFeatures';

export default function NewFeaturePage() {
  const { hasFeature } = useFeatures();

  if (!hasFeature('newFeature')) {
    return <UpgradePlanPrompt feature="newFeature" />;
  }

  return (
    <Layout>
      {/* Your new feature UI */}
    </Layout>
  );
}
```

### 4. Legg til i Navigation (hvis role har tilgang)

```typescript
// components/Layout.tsx
{hasFeature('newFeature') && (user.role === 'ADMIN' || user.role === 'TRAINER') && (
  <NavLink to="/new-feature">Ny Feature</NavLink>
)}
```

### 5. Oppdater Plan Features

```typescript
// platformAdmin.controller.ts
PRO: {
  // ... existing features
  newFeature: true,  // Legg til her
},
```

## üé® Best Practices

### 1. **Separation of Concerns**
- Hver modul har sin egen controller, routes, og page
- Hold business logic i controllers
- Hold UI logic i components/pages

### 2. **Role-Based Access Control (RBAC)**
```typescript
// Alltid sjekk rolle og features
router.post('/classes',
  authenticate,
  authorize('ADMIN', 'TRAINER'),
  requireFeature('booking'),
  classController.create
);
```

### 3. **Feature Toggles**
```typescript
// Bruk feature flags i stedet for √• slette kode
if (hasFeature('betaFeature')) {
  // Ny funksjonalitet
} else {
  // Gammel funksjonalitet
}
```

### 4. **Graceful Degradation**
```typescript
// Hvis feature ikke er tilgjengelig, vis upgrade-prompt
{!hasFeature('analytics') ? (
  <UpgradePrompt feature="analytics" />
) : (
  <AnalyticsDashboard />
)}
```

### 5. **Database Migrations**
- Alltid bruk Prisma migrations
- Test migrations i development f√∏rst
- Backup database f√∏r production migrations

## üöÄ Aktivere/Deaktivere Features

### For √ân Tenant (via API)

```bash
# Aktiver PT-modul for en tenant
curl -X PATCH http://localhost:3000/api/platform/tenants/TENANT_ID/features \
  -H "Authorization: Bearer PLATFORM_ADMIN_TOKEN" \
  -d '{"ptModule": true}'
```

### For Alle Tenants p√• en Plan

```typescript
// platformAdmin.controller.ts
async updateTenantPlan(req, res) {
  const { plan } = req.body;

  // Oppdater features basert p√• plan
  await prisma.tenantFeatures.update({
    where: { tenantId },
    data: this.getPlanFeatures(plan)
  });
}
```

### Via Admin Panel

G√• til **Platform Admin > Tenants > [Velg Tenant] > Features**

## üìä Eksempel: PT-Modul som Feature

### Backend
- ‚úÖ `pt.controller.ts` - H√•ndterer PT-√∏kter
- ‚úÖ `pt.routes.ts` - API endpoints med `requireFeature('ptModule')`

### Frontend
- ‚úÖ `PTSessionsPage.tsx` - Vises kun hvis `hasFeature('ptModule')`
- ‚úÖ Navigation viser "PT √òkter" kun hvis feature er aktivert

### Database
- ‚úÖ `ptSessions` tabell
- ‚úÖ `TenantFeatures.ptModule` boolean
- ‚úÖ Kun BASIC+ planer har tilgang

## üîê Sikkerhet

1. **Alltid valider p√• backend** - Aldri stol p√• frontend checks
2. **Sjekk b√•de rolle OG feature** - Dobbel sikkerhet
3. **Log feature access** - Spor hvem som bruker hva
4. **Rate limiting** - Per feature, ikke bare globalt

## üìù Oppsummering

ObliKey bruker en **modulbasert arkitektur** der:
- ‚úÖ Hver feature er en egen modul (controller + routes + page)
- ‚úÖ Features aktiveres/deaktiveres via `TenantFeatures` tabell
- ‚úÖ Planer (STARTER, BASIC, PRO, ENTERPRISE) mapper til feature-sett
- ‚úÖ Roller (ADMIN, TRAINER, CUSTOMER) bestemmer hvem som kan bruke features
- ‚úÖ Frontend og backend sjekker features uavhengig

Dette gj√∏r det **enkelt** √•:
- üöÄ Legge til nye features
- üîß Aktivere/deaktivere for spesifikke kunder
- üí∞ Lage nye subscription-planer
- üì¶ Deploye kun moduler kunden betaler for
